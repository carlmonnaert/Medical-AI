<!-- filepath: /home/arsnm/code/repos/gitlab/telecom-paris/ia-medical/src/templates/controls.html -->
{% extends "base.html" %}

{% block title %}Simulation Controls{% endblock %}

{% block content %}
<div class="dashboard-header text-center">
    <h1>Hospital Simulation Controls</h1>
    <p class="lead">
        Modify simulation parameters and add events in real-time
        <span id="simulationStatusIndicator" class="badge bg-secondary ms-2">Inactive</span>
    </p>
</div>

<!-- Simulation Control Section -->
<div class="row">
    <div class="col-md-12">
        <div class="dashboard-card">
            <ul class="nav nav-tabs" id="simulationControlTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="parameters-tab" data-bs-toggle="tab" data-bs-target="#parameters" 
                            type="button" role="tab" aria-controls="parameters" aria-selected="true">
                        Modify Parameters
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="events-tab" data-bs-toggle="tab" data-bs-target="#events" 
                            type="button" role="tab" aria-controls="events" aria-selected="false">
                        Add Events
                    </button>
                </li>
            </ul>
            
            <div class="tab-content mt-3" id="simulationControlTabsContent">
                <!-- Parameters Tab -->
                <div class="tab-pane fade show active" id="parameters" role="tabpanel" aria-labelledby="parameters-tab">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="arrivalRateInput" class="form-label">Patient Arrival Rate (per hour)</label>
                                <input type="number" min="1" max="100" class="form-control" id="arrivalRateInput" placeholder="Current rate">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="doctorCountInput" class="form-label">Number of Doctors</label>
                                <input type="number" min="1" max="100" class="form-control" id="doctorCountInput" placeholder="Current count">
                            </div>
                        </div>
                    </div>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button class="btn btn-primary" type="button" id="updateParametersBtn">
                            Update Parameters
                        </button>
                    </div>
                </div>
                
                <!-- Events Tab -->
                <div class="tab-pane fade" id="events" role="tabpanel" aria-labelledby="events-tab">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="eventTypeSelect" class="form-label">Event Type</label>
                                <select class="form-select" id="eventTypeSelect">
                                    <option value="epidemic">Epidemic</option>
                                    <option value="disaster">Disaster</option>
                                    <option value="weather">Weather Event</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="eventDurationInput" class="form-label">Duration (minutes)</label>
                                <input type="number" min="60" step="60" class="form-control" id="eventDurationInput" value="1440">
                                <div class="form-text">Default: 1 day (1440 minutes)</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dynamic event parameters based on selected event type -->
                    <div id="epidemicParams">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="epidemicDiseaseSelect" class="form-label">Disease</label>
                                    <select class="form-select" id="epidemicDiseaseSelect">
                                        <option value="viral_infection">Viral Infection</option>
                                        <option value="pneumonia">Pneumonia</option>
                                        <option value="gastroenteritis">Gastroenteritis</option>
                                        <option value="influenza">Influenza</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="arrivalFactorInput" class="form-label">Arrival Rate Factor</label>
                                    <input type="number" min="0.1" max="5" step="0.1" class="form-control" id="arrivalFactorInput" value="1.5">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="diseaseFactorInput" class="form-label">Disease Prevalence Factor</label>
                                    <input type="number" min="1" max="10" step="0.5" class="form-control" id="diseaseFactorInput" value="3.0">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="disasterParams" style="display: none;">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="disasterTypeSelect" class="form-label">Disaster Type</label>
                                    <select class="form-select" id="disasterTypeSelect">
                                        <option value="earthquake">Earthquake</option>
                                        <option value="fire">Fire</option>
                                        <option value="traffic_accident">Major Traffic Accident</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="disasterArrivalFactorInput" class="form-label">Arrival Rate Factor</label>
                                    <input type="number" min="0.1" max="10" step="0.1" class="form-control" id="disasterArrivalFactorInput" value="2.0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="traumaFactorInput" class="form-label">Trauma Case Factor</label>
                                    <input type="number" min="1" max="10" step="0.5" class="form-control" id="traumaFactorInput" value="5.0">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="weatherParams" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="weatherTypeSelect" class="form-label">Weather Type</label>
                                    <select class="form-select" id="weatherTypeSelect">
                                        <option value="cold">Cold Wave</option>
                                        <option value="heat">Heat Wave</option>
                                        <option value="storm">Storm</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="weatherIntensityInput" class="form-label">Intensity (1-5)</label>
                                    <input type="number" min="1" max="5" class="form-control" id="weatherIntensityInput" value="3">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button class="btn btn-primary" type="button" id="addEventBtn">
                            Add Event
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Status alerts -->
            <div class="mt-3" id="controlStatus" style="display: none;">
            </div>
        </div>
    </div>
</div>

<!-- Active Events Section -->
<div class="row">
    <div class="col-md-12">
        <div class="dashboard-card">
            <h4>Active Events</h4>
            <p class="text-muted">Currently active events in the simulation</p>
            <div id="activeEventsContainer">
                <div class="alert alert-info">No active events. Use the controls above to add events.</div>
            </div>
        </div>
    </div>
</div>

<!-- Parameter History Section -->
<div class="row">
    <div class="col-md-12">
        <div class="dashboard-card">
            <h4>Parameter Change History</h4>
            <p class="text-muted">Record of parameter changes made during the simulation</p>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Parameter</th>
                        <th>Old Value</th>
                        <th>New Value</th>
                    </tr>
                </thead>
                <tbody id="parameterHistoryTable">
                    <tr>
                        <td colspan="4" class="text-center">No parameter changes recorded yet.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Function to modify simulation parameters
    function updateSimulationParameters() {
        if (!currentSimId) return;
        
        const arrivalRate = parseFloat(document.getElementById('arrivalRateInput').value);
        const numDoctors = parseInt(document.getElementById('doctorCountInput').value);
        
        if (isNaN(arrivalRate) || isNaN(numDoctors)) {
            showStatus('controlStatus', 'error', 'Please enter valid values for all parameters');
            return;
        }
        
        // Prepare parameters to update
        const params = {
            sim_id: currentSimId,
            parameters: {
                arrival_rate: arrivalRate,
                num_doctors: numDoctors
            }
        };
        
        // Send update request
        fetch('/api/simulation/modify_parameters', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(params)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showStatus('controlStatus', 'success', 'Parameters updated successfully');
                
                // Update parameter history
                loadParameterHistory();
            } else {
                showStatus('controlStatus', 'error', data.error || 'Failed to update parameters');
            }
        })
        .catch(error => {
            console.error('Error updating parameters:', error);
            showStatus('controlStatus', 'error', 'Error updating parameters. See console for details.');
        });
    }
    
    // Function to add an event to the simulation
    function addEvent() {
        if (!currentSimId) return;
        
        const eventType = document.getElementById('eventTypeSelect').value;
        const durationMinutes = parseInt(document.getElementById('eventDurationInput').value);
        
        let params = {};
        
        // Get parameters based on event type
        if (eventType === 'epidemic') {
            params = {
                disease: document.getElementById('epidemicDiseaseSelect').value,
                arrival_factor: parseFloat(document.getElementById('arrivalFactorInput').value),
                disease_factor: parseFloat(document.getElementById('diseaseFactorInput').value)
            };
        } else if (eventType === 'disaster') {
            params = {
                disaster_type: document.getElementById('disasterTypeSelect').value,
                arrival_factor: parseFloat(document.getElementById('disasterArrivalFactorInput').value),
                trauma_factor: parseFloat(document.getElementById('traumaFactorInput').value)
            };
        } else if (eventType === 'weather') {
            params = {
                weather_type: document.getElementById('weatherTypeSelect').value,
                intensity: parseInt(document.getElementById('weatherIntensityInput').value)
            };
        }
        
        // Prepare request data
        const requestData = {
            sim_id: currentSimId,
            event_type: eventType,
            params: params,
            duration_minutes: durationMinutes
        };
        
        // Send event addition request
        fetch('/api/simulation/add_event', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showStatus('controlStatus', 'success', `${eventType} event added successfully for ${durationMinutes} minutes`);
                
                // Update active events
                loadActiveEvents();
            } else {
                showStatus('controlStatus', 'error', data.error || 'Failed to add event');
            }
        })
        .catch(error => {
            console.error('Error adding event:', error);
            showStatus('controlStatus', 'error', 'Error adding event. See console for details.');
        });
    }
    
    // Load active events for the current simulation
    function loadActiveEvents() {
        if (!currentSimId) return;
        
        fetch(`/api/simulation/active_events?sim_id=${currentSimId}`)
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('activeEventsContainer');
                
                if (!data.events || data.events.length === 0) {
                    container.innerHTML = `<div class="alert alert-info">No active events. Use the controls above to add events.</div>`;
                    return;
                }
                
                let html = '';
                data.events.forEach(event => {
                    const endDate = new Date(event.end_date).toLocaleString();
                    
                    let details = '';
                    if (event.type === 'epidemic') {
                        details = `Disease: ${event.params.disease}, Impact: ${event.params.disease_factor}x`;
                    } else if (event.type === 'disaster') {
                        details = `Type: ${event.params.disaster_type}, Impact: ${event.params.trauma_factor}x trauma cases`;
                    } else if (event.type === 'weather') {
                        details = `Weather: ${event.params.weather_type}, Intensity: ${event.params.intensity}/5`;
                    }
                    
                    const alertClass = event.type === 'epidemic' ? 'alert-danger' : 
                                      (event.type === 'disaster' ? 'alert-warning' : 'alert-info');
                    
                    html += `
                    <div class="alert ${alertClass}">
                        <h5>${event.type.charAt(0).toUpperCase() + event.type.slice(1)} Event</h5>
                        <p>${details}</p>
                        <p><small>Active until: ${endDate}</small></p>
                    </div>`;
                });
                
                container.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading active events:', error);
                document.getElementById('activeEventsContainer').innerHTML = 
                    `<div class="alert alert-danger">Error loading active events. See console for details.</div>`;
            });
    }
    
    // Load parameter change history
    function loadParameterHistory() {
        if (!currentSimId) return;
        
        fetch(`/api/simulation/parameter_history?sim_id=${currentSimId}`)
            .then(response => response.json())
            .then(data => {
                const tableBody = document.getElementById('parameterHistoryTable');
                
                if (!data.changes || data.changes.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="4" class="text-center">No parameter changes recorded yet.</td></tr>`;
                    return;
                }
                
                let html = '';
                data.changes.forEach(change => {
                    const time = new Date(change.sim_date).toLocaleString();
                    
                    // Process each parameter change
                    for (const param in change.new_values) {
                        const oldValue = change.old_values[param];
                        const newValue = change.new_values[param];
                        
                        html += `
                        <tr>
                            <td>${time}</td>
                            <td>${param.replace('_', ' ')}</td>
                            <td>${oldValue}</td>
                            <td>${newValue}</td>
                        </tr>`;
                    }
                });
                
                tableBody.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading parameter history:', error);
                document.getElementById('parameterHistoryTable').innerHTML = 
                    `<tr><td colspan="4" class="text-center text-danger">Error loading parameter history</td></tr>`;
            });
    }
    
    // Page update function for auto-refresh
    function updatePageData() {
        loadActiveEvents();
        loadParameterHistory();
    }
    
    // Toggle event parameter sections based on selected event type
    document.getElementById('eventTypeSelect').addEventListener('change', function() {
        const eventType = this.value;
        
        // Hide all parameter sections
        document.getElementById('epidemicParams').style.display = 'none';
        document.getElementById('disasterParams').style.display = 'none';
        document.getElementById('weatherParams').style.display = 'none';
        
        // Show the relevant section
        if (eventType === 'epidemic') {
            document.getElementById('epidemicParams').style.display = 'block';
        } else if (eventType === 'disaster') {
            document.getElementById('disasterParams').style.display = 'block';
        } else if (eventType === 'weather') {
            document.getElementById('weatherParams').style.display = 'block';
        }
    });
    
    // Simulation change handler
    function onSimulationChange() {
        loadActiveEvents();
        loadParameterHistory();
    }
    
    // Initialize page when it loads
    $(document).ready(function() {
        // Handle parameter update button
        document.getElementById('updateParametersBtn').addEventListener('click', function() {
            updateSimulationParameters();
        });
        
        // Handle add event button
        document.getElementById('addEventBtn').addEventListener('click', function() {
            addEvent();
        });
        
        // Load initial data
        loadActiveEvents();
        loadParameterHistory();
    });
</script>
{% endblock %}