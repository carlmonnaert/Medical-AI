{% extends "base.html" %}

{% block title %}Hospital Dashboard{% endblock %}

{% block content %}
<div class="dashboard-header text-center">
    <h1>Hospital Simulation Dashboard</h1>
    <p class="lead">Real-time monitoring and analytics for hospital operations</p>
</div>

<!-- Summary Stats Row -->
<div class="row" id="summary-stats">
    <div class="col-md-3">
        <div class="dashboard-card text-center">
            <div class="stats-value" id="total-patients">-</div>
            <div class="stats-label">Total Patients</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="dashboard-card text-center">
            <div class="stats-value" id="treated-patients">-</div>
            <div class="stats-label">Treated Patients</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="dashboard-card text-center">
            <div class="stats-value" id="busy-doctors">-</div>
            <div class="stats-label">Busy Doctors</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="dashboard-card text-center">
            <div class="stats-value" id="avg-wait">-</div>
            <div class="stats-label">Avg Wait Time (min)</div>
        </div>
    </div>
</div>

<!-- Main Charts Row -->
<div class="row">
    <div class="col-md-6">
        <div class="dashboard-card">
            <h4>Hospital Activity Timeline</h4>
            <div id="timeline-plot" class="plot-container"></div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="dashboard-card">
            <h4>Disease Distribution</h4>
            <div id="diseases-plot" class="plot-container"></div>
        </div>
    </div>
</div>

<!-- Secondary Charts Row -->
<div class="row">
    <div class="col-md-6">
        <div class="dashboard-card">
            <h4>Hourly Patient Pattern</h4>
            <div id="hourly-pattern-plot" class="plot-container"></div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="dashboard-card">
            <h4>Seasonal Disease Pattern</h4>
            <div id="seasonal-pattern-plot" class="plot-container"></div>
        </div>
    </div>
</div>

<!-- Predictions Row -->
<div class="row">
    <div class="col-md-12">
        <div class="dashboard-card">
            <h4>Patient Arrival Predictions</h4>
            <div id="predictions-plot" class="plot-container"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Dashboard-specific JavaScript
    function updatePageData() {
        updateDashboard();
    }
    
    function updateDashboard() {
        if (!currentSimId) return;
        
        // Fetch summary statistics
        fetch(`/api/summary?sim_id=${currentSimId}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('total-patients').textContent = data.patients_total || 0;
                document.getElementById('treated-patients').textContent = data.patients_treated || 0;
                document.getElementById('busy-doctors').textContent = data.busy_doctors || 0;
                document.getElementById('avg-wait').textContent = data.avg_wait_time?.toFixed(1) || 0;
            })
            .catch(error => console.error('Error fetching summary data:', error));

        // Fetch and display each plot
        fetch(`/api/plot/timeline?sim_id=${currentSimId}`)
            .then(response => response.json())
            .then(data => {
                if (data.plot) {
                    Plotly.newPlot('timeline-plot', data.plot.data, data.plot.layout);
                }
            })
            .catch(error => console.error('Error fetching timeline plot:', error));

        fetch(`/api/plot/diseases?sim_id=${currentSimId}`)
            .then(response => response.json())
            .then(data => {
                if (data.plot) {
                    Plotly.newPlot('diseases-plot', data.plot.data, data.plot.layout);
                }
            })
            .catch(error => console.error('Error fetching diseases plot:', error));

        fetch(`/api/plot/hourly_pattern?sim_id=${currentSimId}`)
            .then(response => response.json())
            .then(data => {
                if (data.plot) {
                    Plotly.newPlot('hourly-pattern-plot', data.plot.data, data.plot.layout);
                }
            })
            .catch(error => console.error('Error fetching hourly pattern plot:', error));

        fetch(`/api/plot/seasonal_pattern?sim_id=${currentSimId}`)
            .then(response => response.json())
            .then(data => {
                if (data.plot) {
                    Plotly.newPlot('seasonal-pattern-plot', data.plot.data, data.plot.layout);
                }
            })
            .catch(error => console.error('Error fetching seasonal pattern plot:', error));
            
        fetch(`/api/plot/predictions?sim_id=${currentSimId}`)
            .then(response => response.json())
            .then(data => {
                if (data.plot) {
                    Plotly.newPlot('predictions-plot', data.plot.data, data.plot.layout);
                }
            })
            .catch(error => console.error('Error fetching predictions plot:', error));
    }

    // Simulation change handler
    function onSimulationChange() {
        updateDashboard();
    }

    // Manual refresh button handler (if needed)
    function setupManualRefresh() {
        const refreshBtn = document.getElementById('manualRefreshBtn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', updateDashboard);
        }
    }

    // Initialize dashboard when page loads
    $(document).ready(function() {
        setupManualRefresh();
        updateDashboard(); // Initial load
    });
</script>
{% endblock %}