<!-- filepath: /home/arsnm/code/repos/gitlab/telecom-paris/ia-medical/src/templates/timeline.html -->
{% extends "base.html" %}

{% block title %}Timeline Explorer{% endblock %}

{% block content %}
<div class="dashboard-header text-center">
    <h1>Hospital Timeline Explorer</h1>
    <p class="lead">View detailed hospital state at specific points in time</p>
</div>

<!-- Timeline Explorer Section -->
<div class="row">
    <div class="col-md-12">
        <div class="dashboard-card">
            <h4>Select Date and Time</h4>
            <p class="text-muted">Choose a specific date and time to view the hospital state at that moment</p>
            
            <div class="timeline-controls mb-4">
                <div class="row">
                    <div class="col-md-4">
                        <label for="timelineDate" class="form-label">Date:</label>
                        <input type="date" class="form-control" id="timelineDate">
                    </div>
                    <div class="col-md-4">
                        <label for="timelineTime" class="form-label">Time:</label>
                        <input type="time" class="form-control" id="timelineTime" step="60">
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button class="btn btn-primary" id="viewTimelineBtn">View Hospital State</button>
                    </div>
                </div>
            </div>
            
            <div id="timelineStateContainer" style="display: none;">
                <div class="row">
                    <div class="col-md-12">
                        <div class="alert alert-info">
                            Hospital state at: <strong><span id="selectedDateTime">-</span></strong>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-3">
                        <div class="hospital-state-card text-center">
                            <div class="stats-value text-white" id="timeline-total-patients">-</div>
                            <div class="stats-label text-white">Total Patients</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="hospital-state-card text-center">
                            <div class="stats-value text-white" id="timeline-waiting-patients">-</div>
                            <div class="stats-label text-white">Waiting Patients</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="hospital-state-card text-center">
                            <div class="stats-value text-white" id="timeline-busy-doctors">-</div>
                            <div class="stats-label text-white">Busy Doctors</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="hospital-state-card text-center">
                            <div class="stats-value text-white" id="timeline-free-doctors">-</div>
                            <div class="stats-label text-white">Free Doctors</div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="dashboard-card">
                            <h5>Doctor Status</h5>
                            <div id="doctor-status-plot" class="plot-container"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="dashboard-card">
                            <h5>Patient Distribution by Specialty</h5>
                            <div id="specialty-distribution-plot" class="plot-container"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Timeline Trend Overview -->
<div class="row">
    <div class="col-md-12">
        <div class="dashboard-card">
            <h4>Hospital State Over Time</h4>
            <p class="text-muted">Timeline of key hospital metrics across the simulation period</p>
            <div id="full-timeline-plot" class="plot-container"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize timeline date picker with default values
    function initTimeline() {
        const today = new Date();
        document.getElementById('timelineDate').valueAsDate = today;
        document.getElementById('timelineTime').value = '12:00';
        
        // Load full timeline plot
        loadFullTimeline();
    }
    
    // Function to view hospital state at a specific time
    function viewHospitalStateAtTime() {
        if (!currentSimId) return;
        
        const dateValue = document.getElementById('timelineDate').value;
        const timeValue = document.getElementById('timelineTime').value;
        
        if (!dateValue || !timeValue) {
            alert('Please select both date and time');
            return;
        }
        
        const selectedDateTime = `${dateValue}T${timeValue}`;
        
        // Fetch hospital state for the selected date and time
        fetch(`/api/timeline_state?sim_id=${currentSimId}&datetime=${selectedDateTime}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                // Update timeline state display
                document.getElementById('selectedDateTime').textContent = new Date(selectedDateTime).toLocaleString();
                document.getElementById('timeline-total-patients').textContent = data.patients_total || 0;
                document.getElementById('timeline-waiting-patients').textContent = data.waiting_patients || 0;
                document.getElementById('timeline-busy-doctors').textContent = data.busy_doctors || 0;
                document.getElementById('timeline-free-doctors').textContent = data.free_doctors || 0;
                
                // Show the state container
                document.getElementById('timelineStateContainer').style.display = 'block';
                
                // Create doctor status pie chart
                const doctorData = [
                    {
                        labels: ['Busy Doctors', 'Free Doctors'],
                        values: [data.busy_doctors, data.free_doctors],
                        type: 'pie',
                        marker: {
                            colors: ['#e74c3c', '#2ecc71']
                        }
                    }
                ];
                
                const doctorLayout = {
                    title: 'Doctor Allocation',
                    height: 400,
                    margin: { t: 40, b: 40, l: 40, r: 40 }
                };
                
                Plotly.newPlot('doctor-status-plot', doctorData, doctorLayout);
                
                // Placeholder for specialty distribution (would need additional API endpoint)
                const specialtyData = [
                    {
                        x: ['Cardiology', 'Emergency', 'Generalist', 'Pediatrics', 'Surgery'],
                        y: [
                            Math.round(Math.random() * data.waiting_patients * 0.2),
                            Math.round(Math.random() * data.waiting_patients * 0.3),
                            Math.round(Math.random() * data.waiting_patients * 0.25),
                            Math.round(Math.random() * data.waiting_patients * 0.15),
                            Math.round(Math.random() * data.waiting_patients * 0.1)
                        ],
                        type: 'bar',
                        marker: {
                            color: 'rgba(0,123,255,0.7)'
                        }
                    }
                ];
                
                const specialtyLayout = {
                    title: 'Patients by Specialty',
                    xaxis: { title: 'Specialty' },
                    yaxis: { title: 'Number of Patients' },
                    height: 400
                };
                
                Plotly.newPlot('specialty-distribution-plot', specialtyData, specialtyLayout);
            })
            .catch(error => {
                console.error('Error fetching timeline state:', error);
                alert('Failed to fetch hospital state for the selected time');
            });
    }
    
    // Load full timeline visualization
    function loadFullTimeline() {
        if (!currentSimId) return;
        
        fetch(`/api/plot/timeline?sim_id=${currentSimId}`)
            .then(response => response.json())
            .then(data => {
                if (data.plot) {
                    Plotly.newPlot('full-timeline-plot', data.plot.data, data.plot.layout);
                }
            })
            .catch(error => console.error('Error fetching timeline plot:', error));
    }
    
    // Page update function for auto-refresh
    function updatePageData() {
        loadFullTimeline();
    }
    
    // Simulation change handler
    function onSimulationChange() {
        loadFullTimeline();
        document.getElementById('timelineStateContainer').style.display = 'none';
    }
    
    // Initialize page when it loads
    $(document).ready(function() {
        initTimeline();
        
        // Handle timeline view button
        document.getElementById('viewTimelineBtn').addEventListener('click', function() {
            viewHospitalStateAtTime();
        });
    });
</script>
{% endblock %}